#include <stdio.h>
#include <stdlib.h>
#include <assert.h>

#include "dafst.h"
#include "probtool.h"
#include "bin2txt.h"
#include "load_double.h"

#ifdef WIN32
#undef USING_MMAP
#endif

#ifdef USING_MMAP
#include <sys/mman.h> // mmap
#include <sys/stat.h> // open
#include <fcntl.h> // open
#include <sys/types.h> // open
#include <unistd.h> // close
#endif

////////////////////////////////////////////////////////////////////////////////
// 메모리 해제
void prob_CloseFST
(
	PROBtFST *ProbFst
) 
{
	if (! ProbFst) return;

	// fst
	if (ProbFst->fst) fst_Close( ProbFst->fst);
	
	// information
	if (ProbFst->info)
	{
		b2t_Close( ProbFst->info);
	}

#ifdef USING_MMAP
	// munmap
	if (ProbFst->mmapsize > 0)
	{
		if ( munmap( (void *)ProbFst->prob, ProbFst->mmapsize) == -1)
		{
			fprintf(stderr, "munmap error\n");
		}
	}
#else
	// 메모리 해제
	if (ProbFst->prob)
	{
		free( ProbFst->prob);
		ProbFst->prob = NULL;
	}
#endif

	free( ProbFst);
	ProbFst = NULL;
}

////////////////////////////////////////////////////////////////////////////////
// fst 파일과 확률값 파일을 읽어들인다.
PROBtFST *prob_OpenFST
(
	const char *FstFileName, 
	const char *ProbFileName
)
{
	PROBtFST *prob_fst = (PROBtFST *)malloc( sizeof(PROBtFST));
	assert (prob_fst != NULL);
	
	// 초기화
	prob_fst->mmapsize = -1;
	prob_fst->info = NULL;
	prob_fst->fst = NULL;
	prob_fst->prob = NULL;
	
	// fst 열기
	fprintf( stderr, "\tLoading FST file.. [%s]", FstFileName);
	if ( (prob_fst->fst = fst_Open( FstFileName, NULL)) == NULL)
	{
		fprintf( stderr, "Load failure! [%s]\n", FstFileName);
		prob_CloseFST( prob_fst);
		return NULL;
	}
	fprintf( stderr, "\t[done]\n");
	
	// 확률 화일 열기
	fprintf( stderr, "\tLoading probability file.. [%s]", ProbFileName);
#ifdef USING_MMAP
	if ((prob_fst->prob = prob_LoadFloat( ProbFileName, &(prob_fst->mmapsize))) == NULL) // 확률 읽기
#else
	if ((prob_fst->prob = prob_LoadFloat( ProbFileName)) == NULL) // 확률 읽기
#endif
	{
		fprintf( stderr, "Load failure! [%s]\n", ProbFileName);
		prob_CloseFST( prob_fst);
		return NULL;
	}
	fprintf( stderr, "\t[done]\n");

	return prob_fst;
}

////////////////////////////////////////////////////////////////////////////////
// fst 파일과 확률값 파일을 읽어들인다.
PROBtFST *prob_OpenWithInfoFST
(
	const char *FstFileName, // 분모에 대한 FST 파일
	const char *InfoFileName, // 분자 리스트 파일
	const char *ProbFileName // 확률 파일
) 
{
	PROBtFST *prob_fst = (PROBtFST *)malloc( sizeof(PROBtFST));
	assert (prob_fst != NULL);

	// 초기화
	prob_fst->mmapsize = -1;
	prob_fst->info = NULL;
	prob_fst->fst = NULL;
	prob_fst->prob = NULL;

	// fst 열기
	fprintf( stderr, "\tLoading FST file.. [%s]", FstFileName);
	if ( (prob_fst->fst = fst_Open( FstFileName, NULL)) == NULL)
	{
		fprintf( stderr, "Load failure [%s]\n", FstFileName);
		prob_CloseFST( prob_fst);
		return NULL;
	}
	fprintf( stderr, "\t[done]\n");
	
	// 정보 화일 열기
	fprintf( stderr, "\tLoading information file.. [%s]", InfoFileName);

	prob_fst->info = b2t_Open( InfoFileName);
	
	if (prob_fst->info == NULL)
	{
		fprintf( stderr, "b2t_Open error [%s]\n", InfoFileName);
		prob_CloseFST( prob_fst);
		return NULL;
	}
	fprintf(stderr, "\t[done]\n");

	// 확률 화일 열기
	fprintf(stderr, "\tLoading probability file.. [%s]", ProbFileName);

#ifdef USING_MMAP
	if ((prob_fst->prob = prob_LoadFloat( ProbFileName, &(prob_fst->mmapsize))) == NULL) // 확률 읽기
#else
	if ((prob_fst->prob = prob_LoadFloat( ProbFileName)) == NULL) // 확률 읽기
#endif
	{
		fprintf( stderr, "Load failure! [%s]\n", ProbFileName);
		prob_CloseFST( prob_fst);
		return NULL;
	}
	fprintf( stderr, "\t[done]\n");

	return prob_fst;
}
